services:
  keycloak-e2e:
    image: quay.io/keycloak/keycloak:25.0.6
    command: ["start-dev", "--import-realm", "--http-port=8080"]
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_HOSTNAME_STRICT: "false"
      KC_HTTP_ENABLED: "true"
    ports:
      - "8181:8080"
    volumes:
      - keycloak_data:/opt/keycloak/data
      - ./keycloak/realm-e2e.json:/opt/keycloak/data/import/realm-e2e.json:ro

  api-mock:
    image: nginx:alpine
    container_name: api-mock
    ports:
      - "9002:80"
    volumes:
      - ./nginx/api-mock.conf:/etc/nginx/conf.d/default.conf:ro

  frontend-e2e:
    image: node:20-alpine
    container_name: frontend-e2e
    working_dir: /app
    volumes:
      - ./:/app
    ports:
      - "5173:5173"
    environment:
      VITE_API_URL: "/api"
      VITE_KEYCLOAK_URL: "http://keycloak-e2e:8080"
      VITE_KEYCLOAK_REALM: "collector-e2e"
      VITE_KEYCLOAK_CLIENT_ID: "collector-frontend"
    depends_on:
      - keycloak-e2e
      - api-mock
    command: sh -lc "npm ci && npm run dev -- --host 0.0.0.0 --port 5173 --mode e2e"

  cypress-e2e:
    image: cypress/included:13.15.0
    container_name: cypress-e2e
    working_dir: /e2e
    volumes:
      - ./:/e2e
    depends_on:
      - frontend-e2e
    environment:
      CYPRESS_baseUrl: "http://frontend-e2e:5173"
      CYPRESS_KEYCLOAK_ORIGIN: "http://localhost:8181"
      TS_NODE_PROJECT: "/e2e/tsconfig.cypress.json"
    command:
      [
        "sh",
        "-lc",
        'node -e "const http=require(''http'');const url=''http://frontend-e2e:5173/'';const deadline=Date.now()+120000;(function tick(){http.get(url,res=>{console.log(''FRONT READY'',res.statusCode);process.exit(0);}).on(''error'',()=>{setTimeout(tick,1000);});})();setTimeout(()=>{console.error(''TIMEOUT waiting front'');process.exit(1);},120000);" ... && cypress run --browser chrome --headless --config-file cypress.config.ts',
      ]

volumes:
  keycloak_data:
