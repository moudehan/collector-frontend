name: CI Frontend (E2E)

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

concurrency:
  group: frontend-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality_and_build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type check
        run: npx tsc --noEmit

      - name: Build
        run: npm run build

  security:
    runs-on: ubuntu-latest
    needs: quality_and_build
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install dependencies
        run: npm ci

      - name: Audit deps (SCA)
        run: npm audit --audit-level=high || true
      - name: Tests with coverage
        run: npm run test:cov

      - name: SonarQube Cloud Scan
        uses: SonarSource/sonarqube-scan-action@v7
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Check Sonar Quality Gate (fail pipeline if FAILED)
        uses: SonarSource/sonarqube-quality-gate-action@v1.1.0
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
      
  tests:
      runs-on: ubuntu-latest
      needs: security
      steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install dependencies (needed for Cypress on host)
        run: npm ci

      - name: Start E2E stack (compose) WITHOUT cypress container
        run: |
          docker compose -f docker-compose.e2e.yml up -d --remove-orphans keycloak-e2e api-mock frontend-e2e
          docker compose -f docker-compose.e2e.yml ps

      - name: Wait for Front on localhost
        run: |
          for i in {1..180}; do
            if curl -fsS -o /dev/null http://localhost:5173/; then
              echo "Front ready on localhost"
              exit 0
            fi
            echo "Front not ready... ($i/180)"
            sleep 1
          done
          echo "TIMEOUT front" && exit 1

      - name: Wait for Keycloak on localhost
        run: |
          for i in {1..180}; do
            if curl -fsS -o /dev/null http://localhost:8080/realms/collector-e2e/.well-known/openid-configuration; then
              echo "Keycloak ready on localhost"
              exit 0
            fi
            echo "Keycloak not ready... ($i/180)"
            sleep 1
          done
          echo "TIMEOUT keycloak" && exit 1

      - name: Run Cypress E2E on host (Electron OK)
        run: |
          CYPRESS_baseUrl="http://localhost:5173" \
          CYPRESS_KEYCLOAK_ORIGIN="http://localhost:8080" \
          npx cypress run --browser electron --config-file cypress.config.ts

      - name: Upload Cypress screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: cypress/screenshots

      - name: Upload Cypress videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: cypress/videos

      - name: Teardown
        if: always()
        run: |
          docker compose -f docker-compose.e2e.yml down -v --remove-orphans

  build:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Upload dist artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist

  docker_image:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image (local tag for kind)
        run: |
          docker build -t collector-frontend:ci .

      - name: Save image (artifact)
        run: |
          docker save collector-frontend:ci -o collector-frontend-ci.tar

      - name: Upload docker image tar
        uses: actions/upload-artifact@v4
        with:
          name: collector-frontend-image
          path: collector-frontend-ci.tar

  deploy_staging_kind:
    runs-on: ubuntu-latest
    needs: docker_image
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4

      - name: Create kind cluster
        uses: helm/kind-action@v1.10.0
        with:
          cluster_name: staging

      - name: Download docker image tar
        uses: actions/download-artifact@v4
        with:
          name: collector-frontend-image

      - name: Load image into Docker
        run: |
          docker load -i collector-frontend-ci.tar
          docker images | head -n 20

      - name: Load image into kind
        run: |
          kind load docker-image collector-frontend:ci --name staging

      - name: Deploy frontend to Kubernetes (staging)
        run: |
          set -e
          kubectl apply -f k8s/frontend-staging.yaml
          kubectl -n staging rollout status deploy/frontend --timeout=180s
          kubectl -n staging get pods,svc -o wide

      - name: Smoke test (healthz)
        run: |
          set -e
          kubectl -n staging run curltest --rm -i --restart=Never \
            --image=curlimages/curl:8.5.0 \
            --command -- sh -lc '
              for i in $(seq 1 20); do
                code=$(curl -s -o /dev/null -w "%{http_code}" http://frontend/healthz || true)
                echo "try $i => HTTP $code"
                [ "$code" = "200" ] && exit 0
                sleep 2
              done
              echo "Frontend not healthy"
              exit 1
            '
  deploy_staging_https:
    name: Deploy staging (HTTPS test) - Frontend
    runs-on: ubuntu-latest
    needs: deploy_staging_kind
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    env:
      K8S_NAMESPACE: staging
      HOST: frontend.staging.local

    steps:
      - uses: actions/checkout@v4

      - name: Create kind cluster
        uses: helm/kind-action@v1.10.0
        with:
          cluster_name: staging

      - name: Label kind node for ingress-nginx
        shell: bash
        run: |
          set -euo pipefail
          NODE=$(kubectl get nodes -o jsonpath='{.items[0].metadata.name}')
          kubectl label node "$NODE" ingress-ready=true --overwrite

      - name: Ensure namespace exists
        shell: bash
        run: |
          set -euo pipefail
          kubectl create namespace "${K8S_NAMESPACE}" --dry-run=client -o yaml | kubectl apply -f -

      - name: Download docker image tar
        uses: actions/download-artifact@v4
        with:
          name: collector-frontend-image

      - name: Load image into Docker
        run: |
          docker load -i collector-frontend-ci.tar
          docker images | head -n 20

      - name: Load image into kind
        run: |
          kind load docker-image collector-frontend:ci --name staging

      - name: Deploy frontend to Kubernetes (staging)
        shell: bash
        run: |
          set -euo pipefail
          kubectl apply -f k8s/frontend-staging.yaml
          kubectl -n "${K8S_NAMESPACE}" rollout status deploy/frontend --timeout=180s
          kubectl -n "${K8S_NAMESPACE}" get pods,svc -o wide

      - name: Install Ingress NGINX (Kind)
        shell: bash
        run: |
          set -euo pipefail
          kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.11.3/deploy/static/provider/kind/deploy.yaml

          kubectl -n ingress-nginx wait --for=condition=complete job/ingress-nginx-admission-create --timeout=300s || true
          kubectl -n ingress-nginx wait --for=condition=complete job/ingress-nginx-admission-patch --timeout=300s || true
          kubectl -n ingress-nginx rollout status deploy/ingress-nginx-controller --timeout=420s

      - name: Create self-signed TLS cert (TEMP)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y openssl

          openssl req -x509 -nodes -days 2 -newkey rsa:2048 \
            -keyout tls.key -out tls.crt \
            -subj "/CN=${HOST}/O=collector-frontend"

          kubectl -n "${K8S_NAMESPACE}" delete secret frontend-tls --ignore-not-found
          kubectl -n "${K8S_NAMESPACE}" create secret tls frontend-tls --cert=tls.crt --key=tls.key

      - name: Apply HTTPS Ingress (TEMP)
        shell: bash
        run: |
          set -euo pipefail

          cat <<EOF | kubectl apply -f -
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: frontend-https
            namespace: ${K8S_NAMESPACE}
            annotations:
              nginx.ingress.kubernetes.io/ssl-redirect: "true"
          spec:
            ingressClassName: nginx
            tls:
              - hosts:
                  - ${HOST}
                secretName: frontend-tls
            rules:
              - host: ${HOST}
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: frontend
                          port:
                            number: 80
          EOF

          kubectl -n "${K8S_NAMESPACE}" get ing frontend-https -o wide

      - name: HTTPS smoke test (via port-forward) - TEMP
        shell: bash
        run: |
          set -euo pipefail

          cleanup() { kill "${PF_PID:-}" >/dev/null 2>&1 || true; }
          trap cleanup EXIT

          kubectl -n ingress-nginx port-forward svc/ingress-nginx-controller 8443:443 >/tmp/pf.log 2>&1 &
          PF_PID=$!
          sleep 5

          echo "Testing HTTPS on https://127.0.0.1:8443 with Host=${HOST}"

          ok_codes="200 204 301 302 401 403"

          for i in $(seq 1 30); do
            code=$(curl -k -s -o /dev/null -w "%{http_code}" \
              "https://127.0.0.1:8443/healthz" -H "Host: ${HOST}" || true)

            echo "try $i => HTTPS $code"
            if echo "$ok_codes" | grep -qw "$code"; then
              echo "HTTPS reachable (HTTP $code)"
              exit 0
            fi
            sleep 2
          done

          echo "HTTPS not reachable"
          tail -200 /tmp/pf.log || true
          kubectl -n ingress-nginx logs deploy/ingress-nginx-controller --tail=200 || true
          kubectl -n "${K8S_NAMESPACE}" get pods,svc,ing -o wide || true
          kubectl -n "${K8S_NAMESPACE}" describe ing frontend-https || true
          kubectl -n "${K8S_NAMESPACE}" logs deploy/frontend --tail=200 || true
          exit 1
